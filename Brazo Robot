#include <SoftwareSerial.h>
#include <Servo.h>

Servo servo01;
Servo servo02;
Servo servo03;
Servo servo04;
Servo servo05;
Servo servo06;

SoftwareSerial Bluetooth(3, 4); // Arduino(RX, TX) - HC-05 Bluetooth (TX, RX)

int servo1PPos, servo2PPos, servo3PPos, servo4PPos, servo5PPos, servo6PPos; // previous position
int servo01SP[50], servo02SP[50], servo03SP[50], servo04SP[50], servo05SP[50], servo06SP[50]; // for storing positions/steps
int speedDelay = 30; // Default delay for slow, smooth movement
int index = 0;
String dataIn = "";

void setup() {
  servo01.attach(5);
  servo02.attach(6);
  servo03.attach(7);
  servo04.attach(8);
  servo05.attach(9);
  servo06.attach(10);

  Serial.begin(9600);
  Bluetooth.begin(38400);
  Bluetooth.setTimeout(1);
  delay(20);
  
  // Robot arm initial position
  servo1PPos = 130; servo01.write(servo1PPos);
  servo2PPos = 180; servo02.write(servo2PPos);
  servo3PPos = 0;   servo03.write(servo3PPos);
  servo4PPos = 35;  servo04.write(servo4PPos);
  servo5PPos = 135; servo05.write(servo5PPos);
  servo6PPos = 45;  servo06.write(servo6PPos);
}

void loop() {
  if (Bluetooth.available() > 0) {
    dataIn = Bluetooth.readString();
    dataIn.trim();
    Serial.print("Datos recibidos: ");
    Serial.println(dataIn);

    if (dataIn.startsWith("s1")) moveServoTo(dataIn.substring(2).toInt(), servo01, servo1PPos);
    if (dataIn.startsWith("s2")) moveServoTo(dataIn.substring(2).toInt(), servo02, servo2PPos);
    if (dataIn.startsWith("s3")) moveServoTo(dataIn.substring(2).toInt(), servo03, servo3PPos);
    if (dataIn.startsWith("s4")) moveServoTo(dataIn.substring(2).toInt(), servo04, servo4PPos);
    if (dataIn.startsWith("s5")) moveServoTo(dataIn.substring(2).toInt(), servo05, servo5PPos);
    if (dataIn.startsWith("s6")) moveServoTo(dataIn.substring(2).toInt(), servo06, servo6PPos);

    if (dataIn.startsWith("ss")) speedDelay = dataIn.substring(2).toInt();
    if (dataIn.startsWith("SAVE")) savePositions();
    if (dataIn.startsWith("RUN")) runservo();
    if (dataIn == "RESET") resetPositions();
  }
}

// Function to move a servo to a new position slowly
void moveServoTo(int newPos, Servo &servo, int &prevPos) {
  if (newPos < 0 || newPos > 180) return;

  if (prevPos > newPos) {
    for (int j = prevPos; j >= newPos; j--) {
      servo.write(j);
      delay(speedDelay);
    }
  } else {
    for (int j = prevPos; j <= newPos; j++) {
      servo.write(j);
      delay(speedDelay);
    }
  }
  prevPos = newPos;
}

void savePositions() {
  if (index < 50) {
    servo01SP[index] = servo1PPos;
    servo02SP[index] = servo2PPos;
    servo03SP[index] = servo3PPos;
    servo04SP[index] = servo4PPos;
    servo05SP[index] = servo5PPos;
    servo06SP[index] = servo6PPos;
    index++;
    Serial.println("Position saved at index: " + String(index - 1));
  } else {
    Serial.println("Memory full");
  }
}

void resetPositions() {
  index = 0;
  Serial.println("Positions reset");
}

void runservo() {
  if (index == 0) {
    Serial.println("No positions saved");
    return;
  }

  Serial.println("Running sequential sequence...");
  bool paused = false;

  while (!paused) {
    for (int i = 0; i < index; i++) {
      // Move each servo one by one (sequentially)
      if (checkInterruption(paused)) break;
      moveServoTo(servo01SP[i], servo01, servo1PPos);

      if (checkInterruption(paused)) break;
      moveServoTo(servo02SP[i], servo02, servo2PPos);

      if (checkInterruption(paused)) break;
      moveServoTo(servo03SP[i], servo03, servo3PPos);

      if (checkInterruption(paused)) break;
      moveServoTo(servo04SP[i], servo04, servo4PPos);

      if (checkInterruption(paused)) break;
      moveServoTo(servo05SP[i], servo05, servo5PPos);

      if (checkInterruption(paused)) break;
      moveServoTo(servo06SP[i], servo06, servo6PPos);
    }
  }
  Serial.println("Sequence stopped/paused");
}

// Helper to check for Bluetooth commands during execution
bool checkInterruption(bool &paused) {
  if (Bluetooth.available() > 0) {
    dataIn = Bluetooth.readString();
    dataIn.trim();
    if (dataIn == "PAUSE") {
      paused = true;
      return true;
    }
    if (dataIn == "RESET") {
      resetPositions();
      paused = true;
      return true;
    }
    if (dataIn.startsWith("ss")) {
      speedDelay = dataIn.substring(2).toInt();
    }
  }
  return false;
}
