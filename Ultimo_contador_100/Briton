#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_ILI9341.h>
#include <XPT2046_Touchscreen.h>
#include <EEPROM.h>

// Pines pantalla (SPI0)
#define TFT_CS   17   // GP17
#define TFT_DC   20   // GP20
#define TFT_RST  21   // GP21
#define TFT_MOSI 19   // GP19
#define TFT_CLK  18   // GP18
#define TFT_MISO 16   // GP16
#define TFT_LED  25   // GP25

// Pines Touchscreen (SPI0)
#define TOUCH_CS   13  // GP13
#define TOUCH_IRQ  12  // GP12

Adafruit_ILI9341 tft = Adafruit_ILI9341(TFT_CS, TFT_DC, TFT_RST);
XPT2046_Touchscreen ts(TOUCH_CS, TOUCH_IRQ);

bool touchProcessed = false; // Variable para evitar repeticiones

void setup() {
  Serial.begin(57600);

  SPI.setSCK(TFT_CLK);
  SPI.setMOSI(TFT_MOSI);
  SPI.setMISO(TFT_MISO);
  SPI.begin();

  pinMode(TFT_CS, OUTPUT);
  digitalWrite(TFT_CS, HIGH);
  pinMode(TFT_DC, OUTPUT);
  pinMode(TFT_RST, OUTPUT);
  digitalWrite(TFT_RST, HIGH);

  pinMode(TFT_LED, OUTPUT);
  digitalWrite(TFT_LED, HIGH);

  pinMode(TOUCH_CS, OUTPUT);
  digitalWrite(TOUCH_CS, HIGH);
  pinMode(TOUCH_IRQ, INPUT);

  tft.begin();
  ts.begin();
  tft.setRotation(3);
  ts.setRotation(1);

  tft.fillScreen(ILI9341_RED);
  delay(500);
  tft.fillScreen(ILI9341_GREEN);
  delay(500);
  tft.fillScreen(ILI9341_BLUE);
  delay(500);

  tft.setTextColor(ILI9341_YELLOW);
  tft.setTextSize(2);
  tft.setCursor(40, 40);
  tft.print("Pico 2040 SPI0 TFT");
}

void loop() {
  if (ts.touched() && !touchProcessed) {
    touchProcessed = true; // Solo procesa el primer toque
    TS_Point p = ts.getPoint();
    Serial.print("Touch: X="); Serial.print(p.x);
    Serial.print(" Y="); Serial.println(p.y);

    tft.fillScreen(ILI9341_BLACK);
    tft.setCursor(10, 20);
    tft.setTextColor(ILI9341_YELLOW);
    tft.print("X:");
    tft.print(p.x);
    tft.print(" Y:");
    tft.print(p.y);
    delay(500);
    tft.fillScreen(ILI9341_BLUE);
  }
  // Cuando sueltas el touch, permite procesar otro evento
  if (!ts.touched()) {
    touchProcessed = false;
  }
}
